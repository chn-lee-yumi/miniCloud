<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.bootcss.com/xterm/3.14.5/xterm.css"/>
    <script src="https://cdn.bootcss.com/xterm/3.14.5/xterm.js"></script>

</head>

<body>
<div id="terminal"></div>
</body>
<script>
    function getQueryVariable(variable)
    {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i=0;i<vars.length;i++) {
            var pair = vars[i].split("=");
            if(pair[0] == variable){return pair[1];}
        }
        return(false);
    }
    var instance = getQueryVariable("instance");
    var ws = new WebSocket("ws://10.0.0.15:5000/console/"+instance);
    //var ws = new WebSocket("ws://127.0.0.1:5001/console");
    var xterm = new Terminal({
        cols: 150,
        rows: 50,
        cursorBlink: 5,
        scrollback: 50,
        tabStopWidth: 4
    });  // Instantiate the terminal

    xterm.open(document.getElementById('terminal'));
    // xterm.write('Hello from \x1B[1;3;31mxterm.js\x1B[0m\n')

     // Log the keyCode of every keyDown event
              xterm.textarea.onkeydown = function (e) {
                console.log('User pressed key with keyCode: ', e.keyCode);
                //console.log('编码',)
                //ws.send(that.encodeBase64Content(e.keyCode.toString()));
                //ws.send('bHM=');
              }

              //xterm.attachCustomKeyEventHandler(function (e) {
               // if (e.keyCode == 13) {
                //  console.log('enter')
                  // ws.send('DQ==')
                  //return false;
                //}
              //});

              xterm.on('data',function(data){
                 console.log('data xterm=>',data)
                 //xterm.write(data);
                 ws.send((data.toString()))
              })

              xterm.on('output', arrayBuffer => {
                console.log('output===',arrayBuffer)
                xterm.write(arrayBuffer);
              });

              xterm.on('blur', arrayBuffer => {
                console.log('blur===',arrayBuffer)
                xterm.write(arrayBuffer);
              });

              xterm.on('focus', arrayBuffer => {
                console.log('focus===',arrayBuffer)
                xterm.write(arrayBuffer);
              });

            /*  xterm.on('key', arrayBuffer => {
                console.log('key===',arrayBuffer)
                xterm.write(arrayBuffer);
              });*/

              xterm.on('keydown', arrayBuffer => {
                console.log('keydown===',arrayBuffer)
                xterm.write(arrayBuffer);
              });


                xterm.on('lineFeed', arrayBuffer => {
                console.log('lineFeed===',arrayBuffer)
                xterm.write(arrayBuffer);
              });

              xterm.on('resize', size => {
                ws.send('resize', [size.cols, size.rows]);
                console.log('resize', [size.cols, size.rows]);
              })

    //申请一个WebSocket对象，参数是服务端地址，同http协议使用http://开头一样，WebSocket协议的url使用ws://开头，另外安全的WebSocket协议使用wss://开头
    ws.onopen = function() { //当WebSocket创建成功时，触发onopen事件
      console.log("open");
      //ws.send("whoami"); //将消息发送到服务端
    }
    ws.onmessage = function(e) { //当客户端收到服务端发来的消息时，触发onmessage事件，参数e.data包含server传递过来的数据
      console.log(e.data);
      xterm.write(e.data);
    }
    ws.onclose = function(e) { //当客户端收到服务端发送的关闭连接请求时，触发onclose事件
      console.log("close");
    }
    ws.onerror = function(e) { //如果出现连接、处理、接收、发送数据失败的时候触发onerror事件
      console.log("connect error")
      console.log(e);
    }

</script>
</html>